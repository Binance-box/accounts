<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Trustee</title>
</head>
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
<style>
    .styled-select {
        background: url(http://i62.tinypic.com/15xvbd5.png) no-repeat 96% 0;
        height: 29px;
    }
</style>

<script type="application/javascript">

    async function makeRequest(method, url) {
        return new Promise(function (resolve, reject) {
            var xhr = new XMLHttpRequest();
            xhr.open(method, url);
            xhr.onload = function () {
                if (this.status >= 200 && this.status < 300) {
                    resolve(xhr.response);
                } else {
                    reject({
                        status: this.status,
                        statusText: xhr.statusText
                    });
                }
            };
            xhr.onerror = function () {
                reject({
                    status: this.status,
                    statusText: xhr.statusText
                });
            };
            xhr.send();
        });
    }

    let loansPromise = makeRequest("GET", "/loans").then(text => JSON.parse(text));
    let accountsPromise = makeRequest("GET", "/accounts").then(text => JSON.parse(text));
    makeRequest("GET", "/me").then(name => document.getElementById("trusteeName").innerText = name);


    Promise.all([loansPromise, accountsPromise]).then(results => {

        let loans = results[0];
        let accounts = results[1];

        //begin loan grouping

        let loansGroupedByAccountKey = _.groupBy(loans, loan => loan.owningAccount);
        let accountsIndexedByKey = _.keyBy(accounts, account => account.key);


        let loansHolder = document.getElementById("loansHolder");
        _.keys(loansGroupedByAccountKey).forEach(accountKey => {

            let account = accountsIndexedByKey[accountKey];
            let accountHeader = document.createElement("h4");
            accountHeader.innerText = account.accountName + " @ " + account.accountHost;

            loansHolder.appendChild(accountHeader);

            let loanTable = document.createElement("table");
            loansHolder.appendChild(loanTable);
            let loansInAccount = loansGroupedByAccountKey[accountKey];

            loansInAccount.forEach(loan => {
                let loanRow = document.createElement("tr");
                let dealIdCell = document.createElement("td");
                let valueCell = document.createElement("td");

                dealIdCell.innerText = loan.dealId;
                valueCell.innerText = loan.valueInUSD;



                loanRow.appendChild(dealIdCell);
                loanRow.appendChild(valueCell);
                loanTable.appendChild(loanRow);

            });
        });

    });

</script>

<body>
<h1>Hello, Trustee <tt id="trusteeName"></tt></h1>


<div id="loansHolder">
    <h3>Loans</h3>
</div>


</body>
</html>